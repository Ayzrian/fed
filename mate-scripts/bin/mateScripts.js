#!/usr/bin/env node

"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var i=require("commander"),e=require("child_process"),s=t(require("fs")),o=t(require("path")),n=t(require("fs-extra"));const r="@mate-academy/scripts";var c="0.1.4";function a(t,i=!0){let s={stdio:"ignore"};i&&(s={stdio:"inherit"});const o=e.execSync(t,s);return o?o.toString():o}function l(t,i=!0){try{return a(t,i)}catch(t){process.exit(1)}}function p(t){return t.includes("package.json")}function m(t){if("test"===process.env.NODE_ENV)return!0;let i;try{const e=s.readFileSync(o.join(t,"package.json"),{encoding:"utf-8"});i=JSON.parse(e)}catch(t){i=null}return i&&i.devDependencies&&i.devDependencies["@mate-academy/scripts"]}function h(t){return"/"===t}var u,y,d,g,f,j;!function(t){t.None="none",t.Layout="layout",t.Javascript="javascript",t.React="react",t.ReactTypescript="reactTypescript"}(u||(u={}));class D{constructor(t){this.projectType=u.None,this.logNoImplementationWarning=()=>{console.warn(`No implementation for command ${this.constructor.name} for ${this.projectType} project`)},this[y]=this.logNoImplementationWarning,this[d]=this.logNoImplementationWarning,this[g]=this.logNoImplementationWarning,this[f]=this.logNoImplementationWarning,this[j]=this.logNoImplementationWarning,this.rootDir=t}async run(t){this.setProjectType(),await this.common(t),await this[this.projectType](t)}setProjectType(){if(this.projectType!==u.None)return;const{mateAcademy:t}=JSON.parse(n.readFileSync(o.join(this.rootDir,"package.json"),{encoding:"utf-8"}));t&&t.projectType?this.projectType=t.projectType:D.logProjectTypeWarning()}static logProjectTypeWarning(){console.warn('package.json should contain\n{\n  ...\n  "mateAcademy": {\n    "projectType": "layout" | "javascript" | "react" | "reactTypescript"\n  }\n}\n')}child(t){return new t(this.rootDir)}}y=u.None,d=u.Layout,g=u.Javascript,f=u.React,j=u.ReactTypescript;class k{constructor(t){return this.rootDir=t,this.configPath=o.join(this.rootDir,"./backstopConfig.js"),this.dataDir=o.join(this.rootDir,"backstop_data"),this.referencesDir=o.join(this.dataDir,"bitmaps_reference"),this.testResultsDir=o.join(this.dataDir,"bitmaps_test"),this.htmlReportDir=o.join(this.dataDir,"html_report"),k.__instance||(k.__instance=this),k.__instance}test(){n.existsSync(this.configPath)&&(this.ensureReferences(),this.cleanTestResults(),k.run("test",{config:this.configPath}))}ensureReferences(){this.areReferencesExists()||this.loadReferences()}areReferencesExists(){return n.existsSync(this.referencesDir)}cleanTestResults(){n.removeSync(this.testResultsDir)}loadReferences(){n.existsSync(this.configPath)&&(this.cleanReference(),k.run("reference",{config:this.configPath}))}cleanReference(){n.removeSync(this.referencesDir)}static run(t,i){l(`backstop ${t} ${Object.entries(i).reduce((t,[i,e])=>`${t} --${i}=${e}`,"")}`)}}class v{constructor(t){return this.rootDir=t,v.__instance||(v.__instance=this),v.__instance}build(t="dist"){a("gulp build --destination "+t)}serve(t="dist"){a("gulp --destination "+t)}}let S=(()=>{class t extends D{constructor(){super(...arguments),this.gitHooksDestinationDir=o.join(this.rootDir,"./.git/hooks"),this.backstop=new k(this.rootDir),this.layout=()=>{this.copyLayoutConfigs(),this.copyLinthtmlConfig(),this.backstop.loadReferences()}}common(){this.copyCommonConfigs(),this.copyGitIgnore(),this.initGitHooks()}copyCommonConfigs(){const i=o.join(t.configsDir,"common");n.copySync(i,this.rootDir)}copyGitIgnore(){n.copySync(o.join(t.configsDir,".gitignore.template"),o.join(this.rootDir,".gitignore"))}copyLayoutConfigs(){const i=o.join(t.configsDir,"layout");n.copySync(i,this.rootDir)}copyLinthtmlConfig(){const i=o.join(this.rootDir,t.lintHtmlConfigDir,t.lintHtmlConfigFileName),e=o.join(this.rootDir,t.lintHtmlConfigFileName);n.copyFileSync(i,e)}initGitHooks(){n.readdirSync(t.gitHooksSourceDir).forEach(t=>this.initGitHook(t))}initGitHook(i){const e=o.join(t.gitHooksSourceDir,i),s=o.join(this.gitHooksDestinationDir,i);n.copySync(e,s),t.makeGitHookExecutable(s)}static makeGitHookExecutable(t){a("chmod +x "+t)}}return t.lintHtmlConfigDir="node_modules/@mate-academy/linthtml-config",t.lintHtmlConfigFileName=".linthtmlrc.json",t.configsDir=o.join(__dirname,"../configs"),t.gitHooksSourceDir=o.join(t.configsDir,"git-hooks"),t})();class b extends D{constructor(){super(...arguments),this.layout=t=>{const{html:i,files:e}=t;i&&b.lintHtml(e)}}common(t){const{styles:i,javascript:e,files:s}=t;i&&b.lintStyles(s),e&&b.lintJs(s)}static lintHtml(t){l("linthtml "+(t?t.join(" "):"./src/**/*.html"))}static lintStyles(t){l("stylelint "+(t?t.join(" "):"./src/**/*.css ./src/**/*.scss"))}static lintJs(t){l("eslint "+(t?t.join(" "):"./src"))}}class R extends D{constructor(){super(...arguments),this.gulp=new v(this.rootDir),this.layout=()=>{this.gulp.build("dist")}}common(){}}class T extends D{constructor(){super(...arguments),this.buildCommand=this.child(R),this.destinationDir=o.join(this.rootDir,"dist"),this.backstop=new k(this.rootDir),this.layout=async()=>{await this.buildCommand.run(),console.log("Start deploy to gh-pages\n");try{this.copyHtmlReport(),this.commitBuild(),T.ensureCanPush(),T.pushGhPagesSubtree(),console.log("Deployed to gh-pages successfully\n")}catch(t){console.log("Error during deploy to gh-pages:"),console.error(t.message)}finally{this.clean()}}}common(){}copyHtmlReport(){n.copySync(o.join(this.backstop.htmlReportDir),o.join(this.destinationDir,"./report/html_report"))}commitBuild(){a(`git add ${this.destinationDir} -f`,!1),a('git commit -m "make build" --no-verify',!1)}static ensureCanPush(){!function(t,i=!0){try{a(t,i)}catch(t){}}("git push --delete origin gh-pages",!1)}static pushGhPagesSubtree(){a("git subtree push --prefix dist origin gh-pages",!1)}clean(){a("git reset --soft HEAD^",!1),a("git restore --staged "+this.destinationDir,!1),n.removeSync(this.destinationDir)}}let C=(()=>{class t extends D{constructor(){super(...arguments),this.layout=()=>{a("npm i -D @mate-academy/scripts");const i=n.readFileSync(o.join(this.rootDir,"package.json"),{encoding:"utf-8"}),e=JSON.parse(i);e.scripts=t.scripts,delete e["lint-staged"],delete e.husky,s.writeFileSync(o.join(this.rootDir,"package.json"),JSON.stringify({...e,...t.mateConfig.layout},null,2)),t.safeRun(()=>n.copySync(o.join(this.rootDir,"config/backstop/backstopConfig.js"),o.join(this.rootDir,"backstopConfig.js"))),t.safeRun(()=>n.removeSync(o.join(this.rootDir,"config"))),t.safeRun(()=>n.removeSync(o.join(this.rootDir,"server.js"))),t.safeRun(()=>n.removeSync(o.join(this.rootDir,".travis.yml"))),a("npm rm @mate-academy/browsersync-config htmllint htmllint-cli husky lint-staged rimraf @mate-academy/htmllint-config"),a("npm i -D @linthtml/linthtml @linthtml/gulp-linthtml gulp gulp-autoprefixer gulp-clean gulp-eslint gulp-replace-path gulp-sass gulp-sourcemaps gulp-stylelint stylelint-scss @mate-academy/linthtml-config"),a("npm i")},this.javascript=()=>{},this.react=()=>{},this.reactTypescript=()=>{}}common(t){this[t.projectType]()}static safeRun(t){try{t()}catch(t){console.error("Migration error",t)}}}return t.scripts={init:"mate-scripts init",start:"mate-scripts start",lint:"mate-scripts lint","test:only":"mate-scripts test",build:"mate-scripts build",deploy:"mate-scripts deploy",update:"mate-scripts update",postinstall:"npm run update",test:"npm run lint && npm run test:only"},t.mateConfig={[u.None]:null,[u.Layout]:{mateAcademy:{projectType:u.Layout}},[u.Javascript]:{mateAcademy:{projectType:u.Javascript}},[u.React]:{mateAcademy:{projectType:u.React}},[u.ReactTypescript]:{mateAcademy:{projectType:u.ReactTypescript}}},t})();const w=new i.Command,x=new class{constructor(){this.rootDir=function(){let t=process.cwd(),i=s.readdirSync(t);try{for(;!p(i)||!m(t);){if(h(t))throw new Error("Command should be run inside project folder with @mate-academy/scripts as devDependency");t=o.join(t,"../"),i=s.readdirSync(t)}}catch(i){console.error(i.message),t=process.cwd()}return t}()}make(t,i,e=!1){const s=new t(e?process.cwd():this.rootDir);return i?(...t)=>{const e=t.pop(),o=i(e,...t);return s.run(o)}:()=>s.run()}};w.name("mate-scripts").version(c,"-v --version","output current version"),w.command("init").description("init linters and configs").action(x.make(S)),w.command("start").description("run development server").action(x.make(class extends D{constructor(){super(...arguments),this.gulp=new v(this.rootDir),this.layout=()=>{this.gulp.serve("dist")}}common(){}})),w.command("lint [files...]").option("-s, --styles","lint styles only",!1).option("-h, --html","lint html only",!1).option("-j, --javascript","lint javascript only",!1).description("lint html, css and js files").action(x.make(b,(t,i)=>{const{styles:e,html:s,javascript:o}=t,n=i&&i.length?i:null;return e||s||o?{styles:e,html:s,javascript:o,files:n}:{styles:!0,html:!0,javascript:!0,files:n}})),w.command("test").description("run tests").action(x.make(class extends D{constructor(){super(...arguments),this.backstop=new k(this.rootDir),this.layout=()=>{this.backstop.test()}}common(){}})),w.command("build").description("create production ready build").action(x.make(R)),w.command("deploy").description("deploy application to gh-pages").action(x.make(T)),w.command("update").description("update @mate-academy/scripts").action(x.make(class extends D{constructor(){super(...arguments),this.layout=()=>{},this.javascript=()=>{},this.react=()=>{},this.reactTypescript=()=>{}}common(){a(`npm i ${r}@$(npm view ${r} version)`),a("npx mate-scripts init")}})),w.command("migrate <type>").description("(global) migrate project to @mate-academy/scripts").action(x.make(C,(t,i)=>({projectType:i}),!0)),w.parse(process.argv);
